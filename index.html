<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Göklerin Mirası - Genişletilmiş Evren</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Cinzel', serif; background-color: #000; cursor: crosshair; }
        canvas { display: block; }

        /* UI Panelleri */
        #ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; color: white; }
        
        /* Diyalog Penceresi */
        #dialog-container {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            width: 70%; background: rgba(10, 10, 15, 0.9); border: 2px solid #daa520;
            padding: 20px; border-radius: 10px; display: none; pointer-events: auto;
            box-shadow: 0 0 20px rgba(218, 165, 32, 0.3);
        }
        #npc-name { color: #daa520; font-size: 20px; font-weight: bold; margin-bottom: 5px; }
        #npc-text { font-size: 18px; line-height: 1.5; color: #ececec; }

        /* Görev Bildirimi */
        #interaction-prompt {
            position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 5px;
            font-size: 14px; display: none; border: 1px solid #fff;
        }

        #health-container { position: absolute; bottom: 30px; left: 30px; width: 200px; height: 15px; background: #222; border: 1px solid #fff; }
        #health-bar { width: 100%; height: 100%; background: #c0392b; }
        
        #crosshair { position: absolute; top: 50%; left: 50%; width: 4px; height: 4px; background: white; border-radius: 50%; transform: translate(-50%, -50%); opacity: 0.8; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>

<div id="ui">
    <div id="crosshair"></div>
    <div id="interaction-prompt">[F] Etkileşime Geç</div>
    
    <div id="dialog-container">
        <div id="npc-name">İsim</div>
        <div id="npc-text">Diyalog içeriği...</div>
        <div style="font-size: 10px; color: #888; margin-top: 10px;">Kapatmak için [F] bas</div>
    </div>

    <div id="health-container"><div id="health-bar"></div></div>
</div>

<script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
</script>

<script type="module">
    import * as THREE from 'three';
    import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

    // --- SAHNE VE AYARLAR ---
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    renderer.setPixelRatio(window.devicePixelRatio);
    document.body.appendChild(renderer.domElement);

    scene.background = new THREE.Color(0x87ceeb);
    scene.fog = new THREE.FogExp2(0x87ceeb, 0.005);

    // Işıklar
    const ambient = new THREE.AmbientLight(0xffffff, 0.5);
    scene.add(ambient);

    const sun = new THREE.DirectionalLight(0xfff5e1, 1.2);
    sun.position.set(50, 100, 50);
    sun.castShadow = true;
    sun.shadow.mapSize.width = 2048;
    sun.shadow.mapSize.height = 2048;
    scene.add(sun);

    // --- MODEL OLUŞTURUCULAR ---

    // 1. Detaylı Ev Oluşturucu
    function createDetailedHouse(x, z, color = 0x8b4513) {
        const house = new THREE.Group();

        // Duvarlar
        const body = new THREE.Mesh(new THREE.BoxGeometry(10, 8, 10), new THREE.MeshStandardMaterial({ color: color }));
        body.position.y = 4;
        body.castShadow = true;
        body.receiveShadow = true;
        house.add(body);

        // Çatı (Daha gerçekçi üçgen prizma)
        const roof = new THREE.Mesh(new THREE.ConeGeometry(8.5, 6, 4), new THREE.MeshStandardMaterial({ color: 0x3e2723 }));
        roof.position.y = 11;
        roof.rotation.y = Math.PI / 4;
        house.add(roof);

        // Kapı
        const door = new THREE.Mesh(new THREE.BoxGeometry(2, 4, 0.5), new THREE.MeshStandardMaterial({ color: 0x2e1a0a }));
        door.position.set(0, 2, 5.1);
        house.add(door);

        // Pencereler
        const winGeo = new THREE.BoxGeometry(1.5, 1.5, 0.2);
        const winMat = new THREE.MeshStandardMaterial({ color: 0xadd8e6, emissive: 0x222222 });
        const win1 = new THREE.Mesh(winGeo, winMat); win1.position.set(-2.5, 5, 5.1); house.add(win1);
        const win2 = new THREE.Mesh(winGeo, winMat); win2.position.set(2.5, 5, 5.1); house.add(win2);

        house.position.set(x, 0, z);
        scene.add(house);
    }

    // 2. İnsansı NPC Oluşturucu
    function createHumanoidNPC(x, z, name, dialog, color = 0x3498db) {
        const npc = new THREE.Group();
        
        // Gövde
        const body = new THREE.Mesh(new THREE.BoxGeometry(0.8, 1.2, 0.5), new THREE.MeshStandardMaterial({ color: color }));
        body.position.y = 1.2;
        npc.add(body);

        // Kafa
        const head = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.5, 0.5), new THREE.MeshStandardMaterial({ color: 0xffdbac }));
        head.position.y = 2.1;
        npc.add(head);

        // Kollar
        const armGeo = new THREE.BoxGeometry(0.3, 1, 0.3);
        const armL = new THREE.Mesh(armGeo, body.material); armL.position.set(-0.6, 1.2, 0); npc.add(armL);
        const armR = new THREE.Mesh(armGeo, body.material); armR.position.set(0.6, 1.2, 0); npc.add(armR);

        npc.position.set(x, 0, z);
        npc.userData = { name, dialog, type: 'npc' };
        scene.add(npc);
        return npc;
    }

    // --- DÜNYA OLUŞTURMA ---
    // Zemin
    const floor = new THREE.Mesh(new THREE.PlaneGeometry(1000, 1000), new THREE.MeshStandardMaterial({ color: 0x3a5f0b }));
    floor.rotation.x = -Math.PI / 2;
    floor.receiveShadow = true;
    scene.add(floor);

    // Köyü Oluştur
    for(let i=0; i<15; i++) {
        const rx = (Math.random() - 0.5) * 150;
        const rz = (Math.random() - 0.5) * 150;
        // Evlerin üst üste binmemesi için basit kontrol
        if(Math.abs(rx) > 10 || Math.abs(rz) > 10) {
            createDetailedHouse(rx, rz, Math.random() > 0.5 ? 0x8b4513 : 0x7a6a5a);
        }
    }

    // NPC'leri Yerleştir
    const npcs = [
        createHumanoidNPC(5, -5, "Köy Muhtarı", "Göklerin mirası tehlikede evlat. Eski tapınağa gitmelisin.", 0x2ecc71),
        createHumanoidNPC(-10, -15, "Demirci", "Kılıcın keskin, yüreğin pek olsun. Henüz yeni silahlar yapamıyorum.", 0xe67e22),
        createHumanoidNPC(20, 10, "Gezgin", "Geceleri ormanda tuhaf ışıklar gördüğümü yemin edebilirim!", 0x9b59b6)
    ];

    // --- KONTROLLER VE ETKİLEŞİM ---
    const controls = new PointerLockControls(camera, document.body);
    document.addEventListener('click', () => {
        if(document.getElementById('dialog-container').style.display !== 'block') controls.lock();
    });

    let moveF = false, moveB = false, moveL = false, moveR = false;
    document.addEventListener('keydown', (e) => {
        if(e.code === 'KeyW') moveF = true; if(e.code === 'KeyS') moveB = true;
        if(e.code === 'KeyA') moveL = true; if(e.code === 'KeyD') moveR = true;
        if(e.code === 'KeyF') tryInteract();
    });
    document.addEventListener('keyup', (e) => {
        if(e.code === 'KeyW') moveF = false; if(e.code === 'KeyS') moveB = false;
        if(e.code === 'KeyA') moveL = false; if(e.code === 'KeyD') moveR = false;
    });

    // Zoom Mekaniği (FOV ile)
    let targetFOV = 75;
    document.addEventListener('wheel', (e) => {
        targetFOV += e.deltaY * 0.05;
        targetFOV = Math.max(30, Math.min(90, targetFOV));
    });

    function tryInteract() {
        if(document.getElementById('dialog-container').style.display === 'block') {
            document.getElementById('dialog-container').style.display = 'none';
            controls.lock();
            return;
        }

        npcs.forEach(npc => {
            if(camera.position.distanceTo(npc.position) < 5) {
                showDialog(npc.userData.name, npc.userData.dialog);
                controls.unlock();
            }
        });
    }

    function showDialog(name, text) {
        document.getElementById('npc-name').innerText = name;
        document.getElementById('npc-text').innerText = text;
        document.getElementById('dialog-container').style.display = 'block';
    }

    // --- OYUN DÖNGÜSÜ ---
    const velocity = new THREE.Vector3();
    const clock = new THREE.Clock();

    function animate() {
        requestAnimationFrame(animate);
        const delta = clock.getDelta();

        if (controls.isLocked) {
            // Hareket Yumuşatma
            velocity.x -= velocity.x * 10.0 * delta;
            velocity.z -= velocity.z * 10.0 * delta;

            if (moveF) velocity.z -= 40.0 * delta;
            if (moveB) velocity.z += 40.0 * delta;
            if (moveL) velocity.x -= 40.0 * delta;
            if (moveR) velocity.x += 40.0 * delta;

            controls.moveRight(-velocity.x * delta);
            controls.moveForward(-velocity.z * delta);
            camera.position.y = 1.7; // Sabit boy seviyesi (Zemine girmeyi önler)
        }

        // Yakınlık Kontrolü (Interaction Prompt)
        let nearNPC = false;
        npcs.forEach(npc => {
            if(camera.position.distanceTo(npc.position) < 5) nearNPC = true;
        });
        document.getElementById('interaction-prompt').style.display = nearNPC ? 'block' : 'none';

        // Zoom Yumuşatma
        camera.fov = THREE.MathUtils.lerp(camera.fov, targetFOV, 0.1);
        camera.updateProjectionMatrix();

        renderer.render(scene, camera);
    }
    animate();

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

</script>
</body>
</html>
